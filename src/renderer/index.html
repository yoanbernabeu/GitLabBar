<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GitLabBar</title>
  <style>
    :root {
      /* Dark theme - Premium palette */
      --bg-base: #0a0a0b;
      --bg-elevated: rgba(18, 18, 20, 0.85);
      --bg-card: rgba(28, 28, 32, 0.6);
      --bg-card-hover: rgba(38, 38, 45, 0.7);
      --bg-card-active: rgba(48, 48, 58, 0.8);

      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.04);

      --text-primary: rgba(255, 255, 255, 0.95);
      --text-secondary: rgba(255, 255, 255, 0.55);
      --text-tertiary: rgba(255, 255, 255, 0.35);
      --text-muted: rgba(255, 255, 255, 0.2);

      /* Accent colors */
      --accent-purple: #8B5CF6;
      --accent-purple-glow: rgba(139, 92, 246, 0.4);
      --accent-blue: #3B82F6;
      --accent-blue-glow: rgba(59, 130, 246, 0.4);
      --accent-cyan: #06B6D4;
      --accent-green: #10B981;
      --accent-green-glow: rgba(16, 185, 129, 0.4);
      --accent-orange: #F59E0B;
      --accent-orange-glow: rgba(245, 158, 11, 0.4);
      --accent-red: #EF4444;
      --accent-red-glow: rgba(239, 68, 68, 0.4);

      /* Gradients */
      --gradient-purple: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
      --gradient-blue: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
      --gradient-green: linear-gradient(135deg, #10B981 0%, #059669 100%);
      --gradient-orange: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      --gradient-red: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      --gradient-mesh: radial-gradient(at 40% 20%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
                       radial-gradient(at 80% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                       radial-gradient(at 0% 50%, rgba(16, 185, 129, 0.08) 0px, transparent 50%);

      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 40px rgba(139, 92, 246, 0.15);

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-base: #f8f9fa;
        --bg-elevated: rgba(255, 255, 255, 0.9);
        --bg-card: rgba(255, 255, 255, 0.7);
        --bg-card-hover: rgba(245, 245, 250, 0.9);
        --bg-card-active: rgba(235, 235, 245, 1);

        --glass-border: rgba(0, 0, 0, 0.08);
        --glass-highlight: rgba(255, 255, 255, 0.5);

        --text-primary: rgba(0, 0, 0, 0.9);
        --text-secondary: rgba(0, 0, 0, 0.55);
        --text-tertiary: rgba(0, 0, 0, 0.35);
        --text-muted: rgba(0, 0, 0, 0.15);

        --gradient-mesh: radial-gradient(at 40% 20%, rgba(139, 92, 246, 0.08) 0px, transparent 50%),
                         radial-gradient(at 80% 0%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                         radial-gradient(at 0% 50%, rgba(16, 185, 129, 0.04) 0px, transparent 50%);

        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      background: var(--bg-base);
      background-image: var(--gradient-mesh);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      user-select: none;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
    }

    /* ═══════════════════════════════════════════
       HEADER
    ═══════════════════════════════════════════ */
    .header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-elevated);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--glass-border);
      position: relative;
      flex-shrink: 0;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--glass-highlight);
    }

    .logo {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      background: var(--gradient-purple);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 14px;
      box-shadow: var(--shadow-md), 0 0 20px var(--accent-purple-glow);
      position: relative;
      overflow: hidden;
    }

    .logo::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .logo svg {
      width: 20px;
      height: 20px;
      fill: white;
      position: relative;
      z-index: 1;
    }

    .header-content {
      flex: 1;
    }

    .header-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 1px;
    }

    .refresh-btn {
      width: 36px;
      height: 36px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .refresh-btn:hover {
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border-color: var(--accent-purple);
      box-shadow: 0 0 20px var(--accent-purple-glow);
    }

    .refresh-btn.spinning svg {
      animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ═══════════════════════════════════════════
       TABS
    ═══════════════════════════════════════════ */
    .tabs {
      display: flex;
      padding: 12px 20px;
      gap: 8px;
      background: var(--bg-elevated);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
    }

    .tab {
      flex: 1;
      min-width: 0;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--gradient-purple);
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .tab:hover {
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border-color: rgba(139, 92, 246, 0.3);
    }

    .tab.active {
      background: transparent;
      border-color: transparent;
      color: white;
      box-shadow: var(--shadow-md), 0 0 30px var(--accent-purple-glow);
    }

    .tab.active::before {
      opacity: 1;
    }

    .tab span {
      position: relative;
      z-index: 1;
    }

    .tab-badge {
      background: rgba(255, 255, 255, 0.15);
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .tab.active .tab-badge {
      background: rgba(255, 255, 255, 0.25);
    }

    /* ═══════════════════════════════════════════
       PROFILE NAV (Developer / Product Owner)
    ═══════════════════════════════════════════ */
    .profile-nav {
      display: flex;
      padding: 8px 20px 12px;
      gap: 6px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
    }

    .profile-nav-item {
      flex: 1;
      min-width: 0;
      padding: 8px 14px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .profile-nav-item:hover {
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border-color: rgba(139, 92, 246, 0.3);
    }

    .profile-nav-item.active {
      background: transparent;
      border-color: var(--accent-purple);
      color: var(--accent-purple);
      box-shadow: 0 0 0 1px var(--accent-purple), 0 0 16px var(--accent-purple-glow);
    }

    /* ═══════════════════════════════════════════
       CONTENT
    ═══════════════════════════════════════════ */
    .content {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 20px;
    }

    .content::-webkit-scrollbar {
      width: 6px;
    }

    .content::-webkit-scrollbar-track {
      background: transparent;
    }

    .content::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    .content::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ═══════════════════════════════════════════
       SECTIONS
    ═══════════════════════════════════════════ */
    .section {
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-left: 4px;
    }

    .section-icon {
      width: 18px;
      height: 18px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .section-icon.review { background: var(--gradient-orange); }
    .section-icon.unassigned { background: var(--gradient-red); }
    .section-icon.assigned { background: var(--gradient-blue); }
    .section-icon.authored { background: var(--gradient-green); }

    .section-icon svg {
      width: 10px;
      height: 10px;
      fill: white;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .section-count {
      font-size: 10px;
      color: var(--text-muted);
      margin-left: auto;
    }

    /* ═══════════════════════════════════════════
       ITEMS
    ═══════════════════════════════════════════ */
    .item {
      display: flex;
      align-items: flex-start;
      padding: 14px 16px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      gap: 14px;
      position: relative;
      overflow: hidden;
    }

    .item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--gradient-purple);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .item:hover {
      background: var(--bg-card-hover);
      border-color: rgba(139, 92, 246, 0.2);
    }

    .item:hover::before {
      opacity: 1;
    }

    .item-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    .item-icon.mr {
      background: var(--gradient-purple);
      box-shadow: 0 4px 12px var(--accent-purple-glow);
    }

    .item-icon.pipeline {
      background: var(--gradient-blue);
      box-shadow: 0 4px 12px var(--accent-blue-glow);
    }

    .item-icon.pipeline.running {
      background: var(--gradient-blue);
      box-shadow: 0 4px 12px var(--accent-blue-glow);
      animation: pulse 2s ease-in-out infinite;
    }

    .item-icon.pipeline.failed {
      background: var(--gradient-red);
      box-shadow: 0 4px 12px var(--accent-red-glow);
    }

    .item-icon.pipeline.success {
      background: var(--gradient-green);
      box-shadow: 0 4px 12px var(--accent-green-glow);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 12px var(--accent-blue-glow); }
      50% { box-shadow: 0 4px 24px var(--accent-blue-glow), 0 0 40px var(--accent-blue-glow); }
    }

    .item-icon svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .item-content {
      flex: 1;
      min-width: 0;
    }

    .item-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      letter-spacing: -0.2px;
    }

    .item-subtitle {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .item-subtitle code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
      background: var(--bg-base);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--text-tertiary);
    }

    .item-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .item-tag {
      font-size: 10px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .item-tag.review {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-orange);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .item-tag.unassigned {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .item-tag.author {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .item-tag.running {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .item-tag.failed {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .item-tag.success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .item-tag.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-orange);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .item-time {
      font-size: 11px;
      color: var(--text-tertiary);
      flex-shrink: 0;
      align-self: flex-start;
      margin-top: 2px;
    }

    .item-dismiss {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: transparent;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.15s ease;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .item:hover .item-dismiss {
      opacity: 1;
    }

    .item-dismiss:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
    }

    .item-dismiss svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .dismissed-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .dismissed-notice button {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dismissed-notice button:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-purple);
    }

    /* ═══════════════════════════════════════════
       EMPTY STATE
    ═══════════════════════════════════════════ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      text-align: center;
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      position: relative;
    }

    .empty-icon::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: var(--gradient-purple);
      opacity: 0.2;
      filter: blur(10px);
    }

    .empty-icon svg {
      width: 32px;
      height: 32px;
      fill: var(--text-tertiary);
      position: relative;
      z-index: 1;
    }

    .empty-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.3px;
    }

    .empty-desc {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      max-width: 260px;
      line-height: 1.5;
    }

    .btn {
      padding: 12px 24px;
      background: var(--gradient-purple);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md), 0 0 20px var(--accent-purple-glow);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover {
      box-shadow: var(--shadow-lg), 0 0 40px var(--accent-purple-glow);
    }

    .btn:hover::before {
      left: 100%;
    }

    /* ═══════════════════════════════════════════
       FOOTER
    ═══════════════════════════════════════════ */
    .footer {
      padding: 14px 20px;
      background: var(--bg-elevated);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .footer-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      position: relative;
    }

    .status-dot::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: inherit;
      opacity: 0.3;
      animation: statusPulse 2s ease-in-out infinite;
    }

    @keyframes statusPulse {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.5); opacity: 0; }
    }

    .status-dot.connected { background: var(--accent-green); }
    .status-dot.warning { background: var(--accent-orange); }
    .status-dot.error { background: var(--accent-red); }
    .status-dot.offline { background: var(--text-muted); }
    .status-dot.offline::after { display: none; }

    .status-text {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .footer-link {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent-purple);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid transparent;
    }

    .footer-link:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.3);
    }

    /* ═══════════════════════════════════════════
       PIPELINE JOBS
    ═══════════════════════════════════════════ */
    .pipeline-jobs {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pipeline-stage {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      border: 1px solid var(--glass-border);
    }

    .stage-header {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 70px;
      max-width: 70px;
      flex-shrink: 0;
    }

    .stage-icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
    }

    .stage-icon svg {
      width: 10px;
      height: 10px;
      fill: var(--text-tertiary);
    }

    .stage-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: capitalize;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stage-jobs {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .job-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      max-width: 110px;
      overflow: hidden;
    }

    .job-chip:hover {
      box-shadow: var(--shadow-sm);
    }

    .job-chip .job-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .job-chip.running .job-status-dot {
      background: var(--accent-blue);
      box-shadow: 0 0 6px var(--accent-blue);
      animation: pulse-dot 1.5s ease-in-out infinite;
    }

    .job-chip.success .job-status-dot {
      background: var(--accent-green);
    }

    .job-chip.failed .job-status-dot {
      background: var(--accent-red);
      box-shadow: 0 0 6px var(--accent-red);
    }

    .job-chip.pending .job-status-dot {
      background: var(--accent-orange);
    }

    .job-chip.skipped .job-status-dot,
    .job-chip.canceled .job-status-dot,
    .job-chip.created .job-status-dot {
      background: var(--text-muted);
    }

    .job-chip.manual .job-status-dot {
      background: var(--accent-orange);
      box-shadow: 0 0 6px var(--accent-orange-glow);
    }

    .job-chip.manual {
      border-color: rgba(245, 158, 11, 0.4);
      color: var(--accent-orange);
    }

    .job-chip:hover.manual {
      background: rgba(245, 158, 11, 0.1);
    }

    .job-manual-icon {
      font-size: 8px;
      line-height: 1;
      flex-shrink: 0;
    }

    .job-chip.running {
      border-color: rgba(59, 130, 246, 0.4);
      color: var(--accent-blue);
    }

    .job-chip.success {
      border-color: rgba(16, 185, 129, 0.3);
    }

    .job-chip.failed {
      border-color: rgba(239, 68, 68, 0.4);
      color: var(--accent-red);
    }

    .job-chip.pending {
      border-color: rgba(245, 158, 11, 0.3);
    }

    .job-chip:hover.running {
      background: rgba(59, 130, 246, 0.1);
    }

    .job-chip:hover.success {
      background: rgba(16, 185, 129, 0.1);
    }

    .job-chip:hover.failed {
      background: rgba(239, 68, 68, 0.1);
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .job-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ═══════════════════════════════════════════
       RELEASES
    ═══════════════════════════════════════════ */
    .release-item {
      position: relative;
    }

    .item-icon.release {
      background: var(--gradient-green);
      box-shadow: 0 4px 12px var(--accent-green-glow);
    }

    .item-icon.release svg {
      width: 18px;
      height: 18px;
    }

    .release-deployment {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--glass-border);
    }

    .release-deployment-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .deployment-trigger {
      font-size: 10px;
      color: var(--text-tertiary);
      font-style: italic;
    }

    .deployment-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-left: auto;
    }

    .deployment-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
    }

    .deployment-badge.success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .deployment-badge.running {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .deployment-badge.failed {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .deployment-badge.created,
    .deployment-badge.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-orange);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .deployment-badge.none {
      background: var(--bg-card);
      color: var(--text-tertiary);
      border: 1px solid var(--glass-border);
    }

    .deployment-badge svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    .deployment-env {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .release-tag {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent-purple);
      padding: 3px 8px;
      border-radius: 6px;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    /* ═══════════════════════════════════════════
       ENHANCED MR & PIPELINE DISPLAY
    ═══════════════════════════════════════════ */
    .item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .item-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--glass-border);
      flex-shrink: 0;
    }

    .item-avatar-placeholder {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--gradient-purple);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .item-author-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .item-author-name {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-author-username {
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .branch-info {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .branch-tag {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 6px;
      background: var(--bg-base);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .branch-tag.source {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      color: var(--accent-blue);
    }

    .branch-tag.target {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      color: var(--accent-green);
    }

    .branch-arrow {
      color: var(--text-muted);
      font-size: 10px;
    }

    .people-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .people-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .people-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .people-avatars {
      display: flex;
      align-items: center;
    }

    .people-avatars .mini-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--bg-card);
      margin-left: -6px;
      object-fit: cover;
    }

    .people-avatars .mini-avatar:first-child {
      margin-left: 0;
    }

    .people-avatars .mini-avatar-placeholder {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--bg-card);
      margin-left: -6px;
      background: var(--gradient-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: 600;
      color: white;
    }

    .people-avatars .mini-avatar-placeholder:first-child {
      margin-left: 0;
    }

    .draft-badge {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 4px;
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-orange);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .conflict-badge {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 4px;
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* ═══════════════════════════════════════════
       MR AGE INDICATORS
    ═══════════════════════════════════════════ */
    .item.mr-age-fresh::before {
      background: linear-gradient(180deg, #10B981, #059669);
      opacity: 1;
    }
    .item.mr-age-warning::before {
      background: linear-gradient(180deg, #F59E0B, #D97706);
      opacity: 1;
    }
    .item.mr-age-alert::before {
      background: linear-gradient(180deg, #F97316, #EA580C);
      opacity: 1;
    }
    .item.mr-age-danger::before {
      background: linear-gradient(180deg, #EF4444, #DC2626);
      opacity: 1;
    }
    .item.mr-age-critical::before {
      background: linear-gradient(180deg, #EF4444, #B91C1C);
      opacity: 1;
      animation: agePulse 2s ease-in-out infinite;
    }

    @keyframes agePulse {
      0%, 100% { opacity: 1; box-shadow: none; }
      50% { opacity: 0.6; box-shadow: -2px 0 8px rgba(239, 68, 68, 0.4); }
    }

    .item-time-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .item-time-badge.fresh {
      background: rgba(16, 185, 129, 0.15);
      color: #10B981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .item-time-badge.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #F59E0B;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .item-time-badge.alert {
      background: rgba(249, 115, 22, 0.15);
      color: #F97316;
      border: 1px solid rgba(249, 115, 22, 0.3);
    }
    .item-time-badge.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #EF4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .item-time-badge.critical {
      background: rgba(239, 68, 68, 0.2);
      color: #F87171;
      border: 1px solid rgba(239, 68, 68, 0.4);
      animation: badgePulse 2s ease-in-out infinite;
    }

    @keyframes badgePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ═══════════════════════════════════════════
       MR NOTES/COMMENTS BADGE
    ═══════════════════════════════════════════ */
    .notes-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 10px;
      flex-shrink: 0;
      background: rgba(139, 92, 246, 0.12);
      color: var(--accent-purple);
      border: 1px solid rgba(139, 92, 246, 0.25);
    }
    .notes-badge.mentioned {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
      border: 1px solid rgba(245, 158, 11, 0.4);
      animation: mentionPulse 2s ease-in-out infinite;
    }
    @keyframes mentionPulse {
      0%, 100% { box-shadow: none; }
      50% { box-shadow: 0 0 8px rgba(245, 158, 11, 0.3); }
    }
    .notes-badge svg {
      width: 11px;
      height: 11px;
      fill: currentColor;
    }
    .notes-badge.clickable {
      cursor: pointer;
    }
    .notes-badge.clickable:hover {
      filter: brightness(1.2);
    }

    /* ═══════════════════════════════════════════
       NOTES PANEL (comment viewer)
    ═══════════════════════════════════════════ */
    .notes-panel {
      position: fixed;
      min-width: 300px;
      max-width: 360px;
      max-height: 280px;
      overflow-y: auto;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 9999;
      padding: 8px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .notes-panel::-webkit-scrollbar {
      width: 6px;
    }
    .notes-panel::-webkit-scrollbar-track {
      background: transparent;
    }
    .notes-panel::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
    }
    .notes-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .notes-panel-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px 8px;
      border-bottom: 1px solid var(--glass-border);
      margin-bottom: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .notes-panel-header svg {
      width: 13px;
      height: 13px;
      fill: var(--accent-purple);
    }
    .notes-panel-close {
      margin-left: auto;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: transparent;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .notes-panel-close:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
    }
    .notes-panel-close svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }
    .note-item {
      padding: 8px;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
    }
    .note-item:last-child {
      margin-bottom: 0;
    }
    .note-author {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    .note-author img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
    }
    .note-author-placeholder {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gradient-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }
    .note-author-name {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .note-author-time {
      font-size: 9px;
      color: var(--text-tertiary);
      margin-left: auto;
    }
    .note-body {
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-secondary);
      word-break: break-word;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
    }
    .note-body code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
      background: var(--bg-base);
      padding: 1px 4px;
      border-radius: 3px;
    }
    .notes-panel-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-tertiary);
      font-size: 11px;
    }
    .notes-panel-empty {
      text-align: center;
      padding: 16px;
      color: var(--text-tertiary);
      font-size: 11px;
    }

    /* ═══════════════════════════════════════════
       MR ACTION BUTTONS (Assign / Add Reviewer)
    ═══════════════════════════════════════════ */
    .mr-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }
    .mr-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px dashed var(--glass-border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }
    .mr-action-btn:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: var(--accent-purple);
      color: var(--accent-purple);
      border-style: solid;
    }
    .mr-action-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    /* Dropdown for member selection */
    .mr-dropdown {
      position: fixed;
      min-width: 240px;
      max-height: 220px;
      overflow-y: auto;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 9999;
      padding: 4px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .mr-dropdown::-webkit-scrollbar {
      width: 6px;
    }
    .mr-dropdown::-webkit-scrollbar-track {
      background: transparent;
    }
    .mr-dropdown::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
    }
    .mr-dropdown::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .mr-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.1s ease;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      color: var(--text-primary);
      font-size: 12px;
    }
    .mr-dropdown-item:hover {
      background: var(--bg-card-hover);
    }
    .mr-dropdown-item.me-item {
      border-bottom: 1px solid var(--glass-border);
      margin-bottom: 2px;
      padding-bottom: 10px;
      font-weight: 600;
      color: var(--accent-purple);
    }
    .mr-dropdown-item img {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      object-fit: cover;
    }
    .mr-dropdown-item .member-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .mr-dropdown-item .member-name {
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mr-dropdown-item .member-username {
      font-size: 9px;
      color: var(--text-tertiary);
    }
    .mr-dropdown-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      color: var(--text-tertiary);
      font-size: 11px;
    }

    .pipeline-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--glass-border);
    }

    .pipeline-trigger-label {
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .pipeline-trigger-user {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pipeline-trigger-user img {
      width: 18px;
      height: 18px;
      border-radius: 50%;
    }

    .pipeline-trigger-user span {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .pipeline-branch {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent-purple);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .pipeline-branch svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    /* ═══════════════════════════════════════════
       LOADING STATE
    ═══════════════════════════════════════════ */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      text-align: center;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--glass-border);
      border-top-color: var(--accent-purple);
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* ═══════════════════════════════════════════
       PRODUCT OWNER VIEW
    ═══════════════════════════════════════════ */
    .po-project-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-left: 4px;
    }

    .po-project-icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: var(--gradient-green);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px var(--accent-green-glow);
    }

    .po-project-icon svg {
      width: 12px;
      height: 12px;
      fill: white;
    }

    .po-project-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }

    .po-project-count {
      font-size: 10px;
      color: var(--text-muted);
      margin-left: auto;
    }

    .po-release-item {
      padding: 14px 16px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .po-release-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--gradient-green);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .po-release-item:hover {
      background: var(--bg-card-hover);
      border-color: rgba(16, 185, 129, 0.2);
    }

    .po-release-item:hover::before {
      opacity: 1;
    }

    .po-release-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .po-release-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .po-release-time {
      font-size: 11px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .po-env-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 6px;
    }

    .po-release-description {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
    }

    .po-release-description.expanded {
      -webkit-line-clamp: unset;
      display: block;
    }

    .po-toggle-desc {
      font-size: 11px;
      color: var(--accent-purple);
      cursor: pointer;
      margin-top: 4px;
      display: inline-block;
      font-weight: 500;
      transition: color 0.15s ease;
    }

    .po-toggle-desc:hover {
      color: var(--accent-blue);
    }

    .po-load-more {
      display: block;
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px dashed var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      margin-bottom: 20px;
    }

    .po-load-more:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-purple);
      color: var(--accent-purple);
    }

    .po-load-more:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .po-env-grid .deployment-badge .deployment-time {
      font-size: 9px;
      opacity: 0.75;
      margin-left: 2px;
    }

    .po-release-description code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      background: var(--bg-base);
      padding: 1px 4px;
      border-radius: 3px;
    }

    .po-release-description strong {
      color: var(--text-primary);
    }

    .po-filter {
      margin-bottom: 16px;
    }

    .po-filter select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      outline: none;
      transition: all 0.2s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .po-filter select:hover {
      border-color: rgba(139, 92, 246, 0.3);
    }

    .po-filter select:focus {
      border-color: var(--accent-purple);
      box-shadow: 0 0 0 3px var(--accent-purple-glow);
    }
  </style>
</head>
<body>
  <div class="app-container">
  <div class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24"><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"/></svg>
    </div>
    <div class="header-content">
      <div class="header-title">GitLabBar</div>
      <div class="header-subtitle" id="headerSubtitle">Loading...</div>
    </div>
    <button class="refresh-btn" id="refreshBtn" title="Refresh">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M13.65 2.35A8 8 0 1 0 16 8h-2a6 6 0 1 1-1.76-4.24L10 6h6V0l-2.35 2.35z"/>
      </svg>
    </button>
  </div>

  <div class="profile-nav" id="profileNav">
    <button type="button" class="profile-nav-item active" data-profile="developer" id="profileDeveloper">Developer</button>
    <button type="button" class="profile-nav-item" data-profile="productOwner" id="profileProductOwner">Product Owner</button>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="mrs">
      <span>MRs</span>
      <span class="tab-badge" id="mrCount">0</span>
    </button>
    <button class="tab" data-tab="pipelines">
      <span>Pipelines</span>
      <span class="tab-badge" id="pipelineCount">0</span>
    </button>
    <button class="tab" data-tab="releases">
      <span>Releases</span>
      <span class="tab-badge" id="releaseCount">0</span>
    </button>
  </div>

  <div class="content">
    <div class="tab-content active" id="mrs-content">
      <div class="loading-state" id="mrs-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading merge requests...</div>
      </div>
      <div class="empty-state" id="mrs-empty" style="display: none;">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24"><path d="M6 3a3 3 0 0 0-3 3v2.25a3 3 0 0 0 3 3h.75v2.25a3 3 0 0 0 3 3h1.5V18a3 3 0 0 0 3 3h3a3 3 0 0 0 3-3v-2.25a3 3 0 0 0-3-3h-.75V10.5a3 3 0 0 0-3-3h-1.5V6a3 3 0 0 0-3-3H6z"/></svg>
        </div>
        <div class="empty-title" id="mrs-empty-title">No Merge Requests</div>
        <div class="empty-desc" id="mrs-empty-desc">Add your GitLab account to track your merge requests in real-time</div>
        <button class="btn" id="addAccountBtn" style="display: none;">Configure GitLab</button>
      </div>
      <div id="mrs-list"></div>
    </div>

    <div class="tab-content" id="pipelines-content">
      <div class="loading-state" id="pipelines-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading pipelines...</div>
      </div>
      <div class="empty-state" id="pipelines-empty" style="display: none;">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        </div>
        <div class="empty-title">No Pipelines</div>
        <div class="empty-desc">Active pipelines from your projects will appear here automatically</div>
      </div>
      <div id="pipelines-list"></div>
    </div>

    <div class="tab-content" id="releases-content">
      <div class="loading-state" id="releases-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading releases...</div>
      </div>
      <div class="empty-state" id="releases-empty" style="display: none;">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        </div>
        <div class="empty-title">No Releases</div>
        <div class="empty-desc">Configure projects to follow in preferences to see their releases</div>
        <button class="btn" id="configReleasesBtn">Configure projects</button>
      </div>
      <div id="releases-list"></div>
    </div>

    <div class="tab-content" id="po-content">
      <div class="po-filter" id="po-filter" style="display: none;">
        <select id="po-project-filter">
          <option value="all">All projects</option>
        </select>
      </div>
      <div class="loading-state" id="po-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading releases...</div>
      </div>
      <div class="empty-state" id="po-empty" style="display: none;">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        </div>
        <div class="empty-title" id="po-empty-title">No Releases</div>
        <div class="empty-desc" id="po-empty-desc">Configure projects to follow in preferences to see their releases</div>
        <button class="btn" id="configPOBtn">Configure projects</button>
      </div>
      <div id="po-list"></div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-status">
      <div class="status-indicator">
        <span class="status-dot offline" id="statusDot"></span>
        <span class="status-text" id="lastUpdate">Not connected</span>
      </div>
    </div>
    <span class="footer-link" id="prefsLink">Preferences</span>
  </div>
  </div>

  <script>
    // State
    let currentTab = 'mrs';
    let mergeRequests = [];
    let pipelines = [];
    let releases = [];
    let lastUpdated = null;
    let isLoading = true;
    let hasAccounts = false;
    let viewMode = 'developer';
    let hasWatchedProjects = false;
    let poReleasesPages = {}; // { projectId: currentPage }
    let poFilterProject = 'all'; // 'all' or a projectPath

    // DOM Elements
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const refreshBtn = document.getElementById('refreshBtn');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const configReleasesBtn = document.getElementById('configReleasesBtn');
    const configPOBtn = document.getElementById('configPOBtn');
    const tabsBar = document.querySelector('.tabs');
    const profileNav = document.getElementById('profileNav');
    const profileNavItems = document.querySelectorAll('.profile-nav-item');
    const poContent = document.getElementById('po-content');
    const prefsLink = document.getElementById('prefsLink');
    const mrCount = document.getElementById('mrCount');
    const pipelineCount = document.getElementById('pipelineCount');
    const releaseCount = document.getElementById('releaseCount');
    const statusDot = document.getElementById('statusDot');
    const lastUpdate = document.getElementById('lastUpdate');
    const headerSubtitle = document.getElementById('headerSubtitle');

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(c => c.classList.remove('active'));
        document.getElementById(`${tabName}-content`).classList.add('active');
        currentTab = tabName;
      });
    });

    // Profile nav (Developer / Product Owner)
    function updateProfileNavUI() {
      profileNavItems.forEach(el => {
        const isActive = (el.dataset.profile === 'developer' && viewMode === 'developer') ||
          (el.dataset.profile === 'productOwner' && viewMode === 'productOwner');
        el.classList.toggle('active', isActive);
        el.setAttribute('aria-pressed', isActive);
      });
    }

    async function setViewMode(mode) {
      if (viewMode === mode) return;
      viewMode = mode;
      try {
        if (window.gitlabbar && window.gitlabbar.config) {
          await window.gitlabbar.config.set('viewMode', mode);
        }
      } catch (err) {
        console.error('Error saving viewMode:', err);
      }
      updateProfileNavUI();
      await loadWatchedProjects();
      applyViewMode();
    }

    profileNavItems.forEach(btn => {
      btn.addEventListener('click', () => {
        const profile = btn.dataset.profile;
        if (profile) setViewMode(profile);
      });
    });

    // Refresh
    refreshBtn.addEventListener('click', () => {
      refreshBtn.classList.add('spinning');
      refresh().finally(() => {
        setTimeout(() => refreshBtn.classList.remove('spinning'), 500);
      });
    });

    // Preferences
    prefsLink.addEventListener('click', openPreferences);
    addAccountBtn.addEventListener('click', openPreferences);
    configReleasesBtn.addEventListener('click', openPreferences);
    configPOBtn.addEventListener('click', openPreferences);

    function openPreferences() {
      if (window.gitlabbar && window.gitlabbar.app) {
        window.gitlabbar.app.showPreferences();
      }
    }

    // Update header subtitle
    function updateHeaderSubtitle() {
      const total = mergeRequests.length + pipelines.length + releases.length;
      if (total === 0) {
        headerSubtitle.textContent = 'No activity';
      } else {
        const parts = [];
        if (mergeRequests.length > 0) parts.push(`${mergeRequests.length} MR${mergeRequests.length > 1 ? 's' : ''}`);
        if (pipelines.length > 0) parts.push(`${pipelines.length} pipeline${pipelines.length > 1 ? 's' : ''}`);
        if (releases.length > 0) parts.push(`${releases.length} release${releases.length > 1 ? 's' : ''}`);
        headerSubtitle.textContent = parts.join(' • ');
      }
    }

    // Render MRs
    let dismissedMRIds = [];

    async function loadDismissedMRs() {
      try {
        if (window.gitlabbar && window.gitlabbar.config) {
          const config = await window.gitlabbar.config.getAll();
          dismissedMRIds = config.dismissedMRs || [];
        }
      } catch (err) {
        console.error('Error loading dismissed MRs:', err);
      }
    }

    function renderMRs() {
      const list = document.getElementById('mrs-list');
      const empty = document.getElementById('mrs-empty');
      const loading = document.getElementById('mrs-loading');
      const emptyTitle = document.getElementById('mrs-empty-title');
      const emptyDesc = document.getElementById('mrs-empty-desc');
      const addAccountBtnEl = document.getElementById('addAccountBtn');

      // Filter hidden MRs
      const visibleMRs = mergeRequests.filter(mr => !dismissedMRIds.includes(mr.id));
      const dismissedCount = mergeRequests.length - visibleMRs.length;

      mrCount.textContent = visibleMRs.length;
      updateHeaderSubtitle();

      // Handle loading state
      if (isLoading) {
        loading.style.display = 'flex';
        empty.style.display = 'none';
        list.innerHTML = '';
        return;
      }

      loading.style.display = 'none';

      if (visibleMRs.length === 0 && dismissedCount === 0) {
        empty.style.display = 'flex';
        // Customize message based on whether accounts are configured
        if (!hasAccounts) {
          emptyTitle.textContent = 'No Merge Requests';
          emptyDesc.textContent = 'Add your GitLab account to track your merge requests in real-time';
          addAccountBtnEl.style.display = 'inline-block';
        } else {
          emptyTitle.textContent = 'No Merge Requests';
          emptyDesc.textContent = 'No open merge requests found for your account';
          addAccountBtnEl.style.display = 'none';
        }
        list.innerHTML = '';
        return;
      }

      empty.style.display = 'none';

      // Group by role
      const toReview = visibleMRs.filter(mr => mr.userRole === 'reviewer');
      const assigned = visibleMRs.filter(mr => mr.userRole === 'assignee');
      const authored = visibleMRs.filter(mr => mr.userRole === 'author');
      const unassigned = visibleMRs.filter(mr => mr.userRole === 'unassigned');

      let html = '';

      // Notice if MRs are hidden
      if (dismissedCount > 0) {
        html += `
          <div class="dismissed-notice">
            <span>${dismissedCount} MR${dismissedCount > 1 ? 's' : ''} hidden</span>
            <button id="restoreMRsBtn">Show all</button>
          </div>
        `;
      }

      if (toReview.length > 0) {
        html += renderSection('To review', toReview, 'review', toReview.length);
      }
      if (unassigned.length > 0) {
        html += renderSection('No reviewer', unassigned, 'unassigned', unassigned.length);
      }
      if (assigned.length > 0) {
        html += renderSection('Assigned', assigned, 'assigned', assigned.length);
      }
      if (authored.length > 0) {
        html += renderSection('Created by me', authored, 'authored', authored.length);
      }

      list.innerHTML = html;

      // Add click handlers for MR items (but not dismiss button or action buttons)
      list.querySelectorAll('.mr-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.item-dismiss') || e.target.closest('.mr-action-btn') || e.target.closest('.mr-dropdown') || e.target.closest('.notes-badge') || e.target.closest('.notes-panel')) return;
          const url = item.dataset.url;
          if (url && window.gitlabbar && window.gitlabbar.app) {
            window.gitlabbar.app.openExternal(url);
          }
        });
      });

      // Click on dismiss MR
      list.querySelectorAll('.mr-item .item-dismiss').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          const mrId = parseInt(btn.dataset.id);
          if (window.gitlabbar && window.gitlabbar.gitlab) {
            await window.gitlabbar.gitlab.dismissMR(mrId);
            dismissedMRIds.push(mrId);
            renderMRs();
          }
        });
      });

      // Action buttons: Assign / Add Reviewer
      list.querySelectorAll('.mr-action-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();

          // Close any existing dropdown
          document.querySelectorAll('.mr-dropdown').forEach(d => d.remove());

          const projectId = parseInt(btn.dataset.projectId);
          const mrIid = parseInt(btn.dataset.mrIid);
          const isAssign = btn.classList.contains('assign-btn');

          // Create and show loading dropdown (fixed position, appended to body)
          const dropdown = document.createElement('div');
          dropdown.className = 'mr-dropdown';
          dropdown.innerHTML = '<div class="mr-dropdown-loading">Loading members...</div>';
          const btnRect = btn.getBoundingClientRect();
          dropdown.style.top = (btnRect.bottom + 4) + 'px';
          dropdown.style.left = btnRect.left + 'px';
          document.body.appendChild(dropdown);

          // Prevent dropdown clicks from propagating
          dropdown.addEventListener('click', (ev) => { ev.stopPropagation(); ev.preventDefault(); });

          try {
            const members = await window.gitlabbar.gitlab.getProjectMembers(projectId);
            if (!members || members.length === 0) {
              dropdown.innerHTML = '<div class="mr-dropdown-loading">No members found</div>';
              setTimeout(() => dropdown.remove(), 2000);
              return;
            }

            // Build dropdown items - "Me" first
            let itemsHtml = `
              <button class="mr-dropdown-item me-item" data-user-id="me">
                <svg viewBox="0 0 24 24" style="width:22px;height:22px;fill:var(--accent-purple);flex-shrink:0;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <div class="member-info">
                  <span class="member-name">Me</span>
                  <span class="member-username">Assign to myself</span>
                </div>
              </button>
            `;
            members.forEach(m => {
              const avatarHtml = m.avatar_url
                ? `<img src="${escapeHtml(m.avatar_url)}" alt="${escapeHtml(m.name)}" />`
                : `<div style="width:22px;height:22px;border-radius:50%;background:var(--gradient-blue);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:white;flex-shrink:0;">${m.name[0].toUpperCase()}</div>`;
              itemsHtml += `
                <button class="mr-dropdown-item" data-user-id="${m.id}">
                  ${avatarHtml}
                  <div class="member-info">
                    <span class="member-name">${escapeHtml(m.name)}</span>
                    <span class="member-username">@${escapeHtml(m.username)}</span>
                  </div>
                </button>
              `;
            });
            dropdown.innerHTML = itemsHtml;

            // Handle member selection
            dropdown.querySelectorAll('.mr-dropdown-item').forEach(item => {
              item.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                ev.preventDefault();
                const userId = item.dataset.userId;
                dropdown.innerHTML = '<div class="mr-dropdown-loading">Updating...</div>';

                try {
                  let result;
                  if (isAssign) {
                    if (userId === 'me') {
                      // Get current user info - use 0 as sentinel for "me" on the API side
                      // GitLab API doesn't support "me" for assignee_ids, we need the user ID
                      // The members list should contain the current user, but we use a dedicated call
                      const allMembers = members;
                      // For "me", we pass [0] and handle it server-side, or we find the current user
                      result = await window.gitlabbar.gitlab.assignMR(projectId, mrIid, [0]);
                    } else {
                      result = await window.gitlabbar.gitlab.assignMR(projectId, mrIid, [parseInt(userId)]);
                    }
                  } else {
                    if (userId === 'me') {
                      result = await window.gitlabbar.gitlab.addReviewer(projectId, mrIid, [0]);
                    } else {
                      result = await window.gitlabbar.gitlab.addReviewer(projectId, mrIid, [parseInt(userId)]);
                    }
                  }
                  dropdown.remove();
                  // Visual feedback on the button
                  btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:12px;height:12px;fill:var(--accent-green);"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Done';
                  btn.style.color = 'var(--accent-green)';
                  btn.style.borderColor = 'var(--accent-green)';
                  btn.style.borderStyle = 'solid';
                  // Trigger refresh - the dataUpdated listener will re-render
                  setTimeout(() => {
                    window.gitlabbar.gitlab.refresh();
                  }, 1000);
                } catch (err) {
                  dropdown.innerHTML = '<div class="mr-dropdown-loading">Error</div>';
                  setTimeout(() => dropdown.remove(), 2000);
                }
              });
            });
          } catch (err) {
            dropdown.innerHTML = '<div class="mr-dropdown-loading">Error loading members</div>';
            setTimeout(() => dropdown.remove(), 2000);
          }
        });
      });

      // Notes badge click - show comments panel
      list.querySelectorAll('.notes-badge.clickable').forEach(badge => {
        badge.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();

          // Toggle: if panel already open for this MR, close it
          const existingPanel = document.querySelector(`.notes-panel[data-mr-iid="${badge.dataset.mrIid}"][data-project-id="${badge.dataset.projectId}"]`);
          document.querySelectorAll('.notes-panel').forEach(p => p.remove());
          document.querySelectorAll('.mr-dropdown').forEach(d => d.remove());
          if (existingPanel) return; // Was open, now closed — done

          const projectId = parseInt(badge.dataset.projectId);
          const mrIid = parseInt(badge.dataset.mrIid);

          // Create panel
          const panel = document.createElement('div');
          panel.className = 'notes-panel';
          panel.dataset.projectId = String(projectId);
          panel.dataset.mrIid = String(mrIid);
          panel.innerHTML = '<div class="notes-panel-loading">Loading comments...</div>';
          const badgeRect = badge.getBoundingClientRect();
          panel.style.top = (badgeRect.bottom + 6) + 'px';
          panel.style.right = (window.innerWidth - badgeRect.right) + 'px';
          document.body.appendChild(panel);

          panel.addEventListener('click', (ev) => { ev.stopPropagation(); });

          try {
            const notes = await window.gitlabbar.gitlab.getMRNotes(projectId, mrIid);
            if (!notes || notes.length === 0) {
              panel.innerHTML = '<div class="notes-panel-empty">No comments</div>';
              return;
            }

            let html = `<div class="notes-panel-header">
              <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
              ${notes.length} comment${notes.length > 1 ? 's' : ''}
              <button class="notes-panel-close" title="Close">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            </div>`;

            notes.slice(0, 10).forEach(note => {
              const avatarHtml = note.author.avatar_url
                ? `<img src="${escapeHtml(note.author.avatar_url)}" alt="${escapeHtml(note.author.name)}" />`
                : `<div class="note-author-placeholder">${note.author.name[0].toUpperCase()}</div>`;

              // Simple markdown-like rendering for the body
              let body = escapeHtml(note.body);
              body = body.replace(/`([^`]+)`/g, '<code>$1</code>');
              body = body.replace(/\n/g, '<br>');

              html += `
                <div class="note-item">
                  <div class="note-author">
                    ${avatarHtml}
                    <span class="note-author-name">${escapeHtml(note.author.name)}</span>
                    <span class="note-author-time">${formatTime(note.createdAt)}</span>
                  </div>
                  <div class="note-body">${body}</div>
                </div>
              `;
            });

            panel.innerHTML = html;
            // Close button handler
            const closeBtn = panel.querySelector('.notes-panel-close');
            if (closeBtn) {
              closeBtn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                panel.remove();
              });
            }
          } catch (err) {
            panel.innerHTML = '<div class="notes-panel-empty">Error loading comments</div>';
          }
        });
      });

      // Close dropdowns/panels - use a single global handler (set once)
      if (!window._popupCloseHandlerSet) {
        window._popupCloseHandlerSet = true;
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.mr-action-btn') && !e.target.closest('.mr-dropdown')) {
            document.querySelectorAll('.mr-dropdown').forEach(d => d.remove());
          }
          if (!e.target.closest('.notes-badge') && !e.target.closest('.notes-panel')) {
            document.querySelectorAll('.notes-panel').forEach(p => p.remove());
          }
        });
      }

      // Button to show all MRs
      const restoreBtn = document.getElementById('restoreMRsBtn');
      if (restoreBtn) {
        restoreBtn.addEventListener('click', async () => {
          if (window.gitlabbar && window.gitlabbar.gitlab) {
            await window.gitlabbar.gitlab.restoreMRs();
            dismissedMRIds = [];
            renderMRs();
          }
        });
      }
    }

    function renderSection(title, items, type, count) {
      const iconSvg = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/></svg>';
      return `
        <div class="section">
          <div class="section-header">
            <div class="section-icon ${type}">${iconSvg}</div>
            <span class="section-title">${title}</span>
            <span class="section-count">${count}</span>
          </div>
          ${items.map(mr => {
            // Author avatar
            const authorAvatar = mr.author?.avatar_url
              ? `<img class="item-avatar" src="${escapeHtml(mr.author.avatar_url)}" alt="${escapeHtml(mr.author.name)}" />`
              : `<div class="item-avatar-placeholder">${(mr.author?.name || '?')[0].toUpperCase()}</div>`;

            // Assignees
            const assigneesHtml = mr.assignees && mr.assignees.length > 0
              ? `<div class="people-group">
                  <span class="people-label">Assigned</span>
                  <div class="people-avatars">
                    ${mr.assignees.slice(0, 3).map(a =>
                      a.avatar_url
                        ? `<img class="mini-avatar" src="${escapeHtml(a.avatar_url)}" alt="${escapeHtml(a.name)}" title="${escapeHtml(a.name)}" />`
                        : `<div class="mini-avatar-placeholder" title="${escapeHtml(a.name)}">${a.name[0].toUpperCase()}</div>`
                    ).join('')}
                    ${mr.assignees.length > 3 ? `<div class="mini-avatar-placeholder">+${mr.assignees.length - 3}</div>` : ''}
                  </div>
                </div>`
              : '';

            // Reviewers
            const reviewersHtml = mr.reviewers && mr.reviewers.length > 0
              ? `<div class="people-group">
                  <span class="people-label">Reviewers</span>
                  <div class="people-avatars">
                    ${mr.reviewers.slice(0, 3).map(r =>
                      r.avatar_url
                        ? `<img class="mini-avatar" src="${escapeHtml(r.avatar_url)}" alt="${escapeHtml(r.name)}" title="${escapeHtml(r.name)}" />`
                        : `<div class="mini-avatar-placeholder" title="${escapeHtml(r.name)}">${r.name[0].toUpperCase()}</div>`
                    ).join('')}
                    ${mr.reviewers.length > 3 ? `<div class="mini-avatar-placeholder">+${mr.reviewers.length - 3}</div>` : ''}
                  </div>
                </div>`
              : '';

            // Draft & Conflict badges
            const draftBadge = mr.draft ? '<span class="draft-badge">Draft</span>' : '';
            const conflictBadge = mr.hasConflicts ? '<span class="conflict-badge">Conflicts</span>' : '';

            // Age indicator
            const ageInfo = getAgeInfo(mr.createdAt);

            // Notes/comments badge
            const mentionedClass = mr.userMentionedInNotes ? ' mentioned' : '';
            const notesBadge = mr.userNotesCount > 0
              ? `<span class="notes-badge clickable${mentionedClass}" data-project-id="${mr.projectId}" data-mr-iid="${mr.iid}" title="${mr.userMentionedInNotes ? 'You are mentioned - click to view' : 'Click to view comments'}"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>${mr.userNotesCount}${mr.userMentionedInNotes ? ' @' : ''}</span>`
              : '';

            return `
              <div class="item mr-item ${ageInfo.itemClass}" data-url="${mr.webUrl}">
                <div class="item-content" style="width: 100%;">
                  <div class="item-header">
                    ${authorAvatar}
                    <div class="item-author-info">
                      <span class="item-author-name">${escapeHtml(mr.author?.name || 'Unknown')}</span>
                      <span class="item-author-username">@${escapeHtml(mr.author?.username || '')}</span>
                    </div>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 6px;">
                      ${notesBadge}
                      <span class="item-time-badge ${ageInfo.badgeClass}">${formatTime(mr.createdAt)}</span>
                      <button class="item-dismiss" data-id="${mr.id}" title="Hide this MR" style="opacity: 0.5;">
                        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                      </button>
                    </div>
                  </div>
                  <div class="item-title" style="margin-bottom: 6px;">${draftBadge} ${escapeHtml(mr.title)}</div>
                  <div class="item-subtitle" style="margin-bottom: 4px;">
                    ${escapeHtml(mr.projectPath || mr.projectName)}
                    <code>!${mr.iid}</code>
                    ${conflictBadge}
                  </div>
                  <div class="branch-info">
                    <span class="branch-tag source" title="${escapeHtml(mr.sourceBranch)}">${escapeHtml(mr.sourceBranch)}</span>
                    <span class="branch-arrow">→</span>
                    <span class="branch-tag target" title="${escapeHtml(mr.targetBranch)}">${escapeHtml(mr.targetBranch)}</span>
                  </div>
                  ${(assigneesHtml || reviewersHtml) ? `<div class="people-row">${assigneesHtml}${reviewersHtml}</div>` : ''}
                  ${(!mr.assignees || mr.assignees.length === 0 || !mr.reviewers || mr.reviewers.length === 0) ? `
                  <div class="mr-actions">
                    ${(!mr.assignees || mr.assignees.length === 0) ? `
                      <button class="mr-action-btn assign-btn" data-project-id="${mr.projectId}" data-mr-iid="${mr.iid}" data-mr-id="${mr.id}">
                        <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        + Assign
                      </button>
                    ` : ''}
                    ${(!mr.reviewers || mr.reviewers.length === 0) ? `
                      <button class="mr-action-btn reviewer-btn" data-project-id="${mr.projectId}" data-mr-iid="${mr.iid}" data-mr-id="${mr.id}">
                        <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                        + Reviewer
                      </button>
                    ` : ''}
                  </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Render Pipelines
    let dismissedPipelineIds = [];

    async function loadDismissedPipelines() {
      try {
        if (window.gitlabbar && window.gitlabbar.config) {
          const config = await window.gitlabbar.config.getAll();
          dismissedPipelineIds = config.dismissedPipelines || [];
        }
      } catch (err) {
        console.error('Error loading dismissed pipelines:', err);
      }
    }

    function renderPipelines() {
      const list = document.getElementById('pipelines-list');
      const empty = document.getElementById('pipelines-empty');
      const loading = document.getElementById('pipelines-loading');

      // Filter hidden pipelines
      const visiblePipelines = pipelines.filter(p => !dismissedPipelineIds.includes(p.id));
      const dismissedCount = pipelines.length - visiblePipelines.length;

      pipelineCount.textContent = visiblePipelines.length;
      updateHeaderSubtitle();

      // Handle loading state
      if (isLoading) {
        loading.style.display = 'flex';
        empty.style.display = 'none';
        list.innerHTML = '';
        return;
      }

      loading.style.display = 'none';

      if (visiblePipelines.length === 0 && dismissedCount === 0) {
        empty.style.display = 'flex';
        list.innerHTML = '';
        return;
      }

      empty.style.display = 'none';

      let html = '';

      // Notice if pipelines are hidden
      if (dismissedCount > 0) {
        html += `
          <div class="dismissed-notice">
            <span>${dismissedCount} pipeline${dismissedCount > 1 ? 's' : ''} hidden</span>
            <button id="restorePipelinesBtn">Show all</button>
          </div>
        `;
      }

      html += visiblePipelines.map(pipeline => {
        const statusClass = pipeline.status;
        const statusText = {
          running: 'Running',
          failed: 'Failed',
          success: 'Success',
          pending: 'Pending',
          canceled: 'Canceled'
        }[pipeline.status] || pipeline.status;

        // Group jobs by stage
        const jobsByStage = {};
        if (pipeline.jobs && pipeline.jobs.length > 0) {
          pipeline.jobs.forEach(job => {
            if (!jobsByStage[job.stage]) {
              jobsByStage[job.stage] = [];
            }
            jobsByStage[job.stage].push(job);
          });
        }

        const jobsHtml = Object.keys(jobsByStage).length > 0 ? `
          <div class="pipeline-jobs">
            ${Object.entries(jobsByStage).map(([stage, jobs]) => `
              <div class="pipeline-stage">
                <div class="stage-header">
                  <div class="stage-icon">
                    <svg viewBox="0 0 16 16"><path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"/></svg>
                  </div>
                  <span class="stage-label">${escapeHtml(stage)}</span>
                </div>
                <div class="stage-jobs">
                  ${jobs.map(job => `
                    <span class="job-chip ${job.status}" data-url="${job.webUrl}" title="${escapeHtml(job.name)}">
                      <span class="job-status-dot"></span>
                      ${job.status === 'manual' ? '<span class="job-manual-icon">▶</span>' : ''}
                      <span class="job-name">${escapeHtml(job.name)}</span>
                    </span>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        ` : '';

        // User who triggered the pipeline
        const userHtml = pipeline.user ? `
          <div class="pipeline-trigger">
            <span class="pipeline-trigger-label">Triggered by</span>
            <div class="pipeline-trigger-user">
              ${pipeline.user.avatar_url
                ? `<img src="${escapeHtml(pipeline.user.avatar_url)}" alt="${escapeHtml(pipeline.user.name)}" />`
                : ''}
              <span>${escapeHtml(pipeline.user.name || pipeline.user.username)}</span>
            </div>
          </div>
        ` : '';

        // Source of the pipeline
        const sourceText = {
          push: 'Push',
          web: 'Web',
          schedule: 'Schedule',
          api: 'API',
          trigger: 'Trigger',
          merge_request_event: 'MR',
          pipeline: 'Pipeline',
          parent_pipeline: 'Parent',
          external: 'External'
        }[pipeline.source] || pipeline.source;

        return `
          <div class="item pipeline-item" data-url="${pipeline.webUrl}">
            <div class="item-icon pipeline ${statusClass}">
              <svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm${pipeline.status === 'running' ? '-.5 4.75a.75.75 0 0 1 1.5 0v3.5a.75.75 0 0 1-1.5 0v-3.5zM8 12a1 1 0 1 1 0-2 1 1 0 0 1 0 2' : '3.5 7.5a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h7'}z"/></svg>
            </div>
            <div class="item-content">
              <div class="item-header" style="margin-bottom: 6px;">
                <div style="flex: 1;">
                  <div class="item-title" style="margin-bottom: 4px;">${escapeHtml(pipeline.projectPath || pipeline.projectName || 'Pipeline')}</div>
                  <div class="item-subtitle">
                    <span class="pipeline-branch" title="${escapeHtml(pipeline.ref)}">
                      <svg viewBox="0 0 16 16"><path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5zM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5z"/></svg>
                      ${escapeHtml(pipeline.ref)}
                    </span>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="item-time">${formatTime(pipeline.createdAt)}</span>
                  <button class="item-dismiss" data-id="${pipeline.id}" title="Hide this pipeline" style="opacity: 0.5;">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                  </button>
                </div>
              </div>
              <div class="item-meta" style="margin-bottom: 8px;">
                <span class="item-tag ${statusClass}">${statusText}</span>
                <span class="item-tag" style="background: var(--bg-base); color: var(--text-tertiary); border: 1px solid var(--glass-border);">${sourceText}</span>
              </div>
              ${userHtml}
              ${jobsHtml}
            </div>
          </div>
        `;
      }).join('');

      list.innerHTML = html;

      // Click on pipeline items (but not on jobs or dismiss)
      list.querySelectorAll('.pipeline-item').forEach(item => {
        item.addEventListener('click', (e) => {
          // If clicking on a job or dismiss, don't open the pipeline
          if (e.target.closest('.job-chip') || e.target.closest('.item-dismiss')) return;
          const url = item.dataset.url;
          if (url && window.gitlabbar && window.gitlabbar.app) {
            window.gitlabbar.app.openExternal(url);
          }
        });
      });

      // Click on individual jobs
      list.querySelectorAll('.job-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
          e.stopPropagation();
          const url = chip.dataset.url;
          if (url && window.gitlabbar && window.gitlabbar.app) {
            window.gitlabbar.app.openExternal(url);
          }
        });
      });

      // Click on dismiss
      list.querySelectorAll('.item-dismiss').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          const pipelineId = parseInt(btn.dataset.id);
          if (window.gitlabbar && window.gitlabbar.gitlab) {
            await window.gitlabbar.gitlab.dismissPipeline(pipelineId);
            dismissedPipelineIds.push(pipelineId);
            renderPipelines();
          }
        });
      });

      // Button to show all
      const restoreBtn = document.getElementById('restorePipelinesBtn');
      if (restoreBtn) {
        restoreBtn.addEventListener('click', async () => {
          if (window.gitlabbar && window.gitlabbar.gitlab) {
            await window.gitlabbar.gitlab.restorePipelines();
            dismissedPipelineIds = [];
            renderPipelines();
          }
        });
      }
    }

    // Job status icons
    function getJobIcon(status) {
      const icons = {
        running: '<svg class="job-icon running" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0z"/><path d="M8 3a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 3z"/></svg>',
        success: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 1 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0z"/></svg>',
        failed: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/></svg>',
        pending: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="3"/></svg>',
        skipped: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M6.5 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5z"/></svg>',
        canceled: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM5.5 5.5h5v5h-5v-5z"/></svg>',
        manual: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1-1.5 0v-6.5A.75.75 0 0 1 8 4z"/><path d="M4.75 7.25a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5z"/></svg>',
        created: '<svg class="job-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="2"/></svg>'
      };
      return icons[status] || icons.created;
    }

    // Render Releases
    let dismissedReleaseIds = [];

    async function loadDismissedReleases() {
      try {
        if (window.gitlabbar && window.gitlabbar.config) {
          const config = await window.gitlabbar.config.getAll();
          dismissedReleaseIds = config.dismissedReleases || [];
        }
      } catch (err) {
        console.error('Error loading dismissed releases:', err);
      }
    }

    function renderReleases() {
      const list = document.getElementById('releases-list');
      const empty = document.getElementById('releases-empty');
      const loading = document.getElementById('releases-loading');

      // Filter hidden releases
      const visibleReleases = releases.filter(r => !dismissedReleaseIds.includes(r.id));
      const dismissedCount = releases.length - visibleReleases.length;

      releaseCount.textContent = visibleReleases.length;
      updateHeaderSubtitle();

      // Handle loading state
      if (isLoading) {
        loading.style.display = 'flex';
        empty.style.display = 'none';
        list.innerHTML = '';
        return;
      }

      loading.style.display = 'none';

      if (visibleReleases.length === 0 && dismissedCount === 0) {
        empty.style.display = 'flex';
        list.innerHTML = '';
        return;
      }

      empty.style.display = 'none';

      // Group releases by project
      const releasesByProject = {};
      visibleReleases.forEach(release => {
        const key = release.projectPath || release.projectName || 'Unknown';
        if (!releasesByProject[key]) {
          releasesByProject[key] = [];
        }
        releasesByProject[key].push(release);
      });

      let html = '';

      // Notice if releases are hidden
      if (dismissedCount > 0) {
        html += `
          <div class="dismissed-notice">
            <span>${dismissedCount} release${dismissedCount > 1 ? 's' : ''} hidden</span>
            <button id="restoreReleasesBtn">Show all</button>
          </div>
        `;
      }

      Object.entries(releasesByProject).forEach(([projectPath, projectReleases]) => {
        html += `
          <div class="section">
            <div class="section-header">
              <div class="section-icon release" style="background: var(--gradient-green);">
                <svg viewBox="0 0 24 24" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
              </div>
              <span class="section-title">${escapeHtml(projectPath)}</span>
              <span class="section-count">${projectReleases.length}</span>
            </div>
            ${projectReleases.map(release => {
              const deployments = release.deployments || [];
              const deploymentStatusTexts = {
                success: 'Deployed',
                running: 'Deploying...',
                failed: 'Failed',
                created: 'Pending',
                canceled: 'Canceled',
              };
              const deploymentIcons = {
                success: '<svg viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 1 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0z"/></svg>',
                running: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="20" stroke-dashoffset="10"/></svg>',
                failed: '<svg viewBox="0 0 16 16"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/></svg>',
                created: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="3"/></svg>',
                canceled: '<svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM5.5 5.5h5v5h-5v-5z"/></svg>',
              };

              let deploymentsHtml;
              if (deployments.length === 0) {
                deploymentsHtml = `
                  <div class="release-deployment-row">
                    <span class="deployment-badge none">
                      <svg viewBox="0 0 16 16"><path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/><path d="M8 4a.75.75 0 0 1 .75.75v2.5h2.5a.75.75 0 0 1 0 1.5h-2.5v2.5a.75.75 0 0 1-1.5 0v-2.5h-2.5a.75.75 0 0 1 0-1.5h2.5v-2.5A.75.75 0 0 1 8 4z"/></svg>
                      Not deployed
                    </span>
                  </div>`;
              } else {
                deploymentsHtml = deployments.map(dep => {
                  const triggerInfo = dep.triggeredBy
                    ? `<span class="deployment-trigger">by ${escapeHtml(dep.triggeredBy.name)}</span>`
                    : '';
                  const timeInfo = dep.deployedAt
                    ? `<span class="deployment-time">${formatDateTime(dep.deployedAt)}</span>`
                    : '';
                  return `
                  <div class="release-deployment-row">
                    <span class="deployment-badge ${dep.status}">
                      ${deploymentIcons[dep.status] || ''}
                      ${deploymentStatusTexts[dep.status] || 'Unknown'}
                    </span>
                    <span class="deployment-env">${escapeHtml(dep.environment)}</span>
                    ${triggerInfo}
                    ${timeInfo}
                  </div>
                `}).join('');
              }

              return `
                <div class="item release-item" data-url="${release.webUrl}">
                  <div class="item-icon release">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.69 0 1.36-.08 2-.21v-2.01c-.64.14-1.31.22-2 .22-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8c0 .69-.08 1.36-.22 2h2.01c.13-.64.21-1.31.21-2 0-5.52-4.48-10-10-10zm-2 13l-4-4 1.41-1.41L10 12.17l6.59-6.59L18 7l-8 8z"/></svg>
                  </div>
                  <div class="item-content">
                    <div class="item-title">${escapeHtml(release.name || release.tagName)}</div>
                    <div class="item-subtitle">
                      <span class="release-tag">${escapeHtml(release.tagName)}</span>
                    </div>
                    <div class="release-deployment">
                      ${deploymentsHtml}
                    </div>
                  </div>
                  <span class="item-time">${formatTime(release.releasedAt || release.createdAt)}</span>
                  <button class="item-dismiss" data-id="${release.id}" title="Hide this release">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        `;
      });

      list.innerHTML = html;

      // Add click handlers (but not on dismiss button)
      list.querySelectorAll('.release-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.item-dismiss')) return;
          const url = item.dataset.url;
          if (url && window.gitlabbar && window.gitlabbar.app) {
            window.gitlabbar.app.openExternal(url);
          }
        });
      });

      // Click on dismiss release
      list.querySelectorAll('.release-item .item-dismiss').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          const releaseId = parseInt(btn.dataset.id);
          if (window.gitlabbar && window.gitlabbar.gitlab) {
            await window.gitlabbar.gitlab.dismissRelease(releaseId);
            dismissedReleaseIds.push(releaseId);
            renderReleases();
          }
        });
      });

      // Button to show all releases
      const restoreBtn = document.getElementById('restoreReleasesBtn');
      if (restoreBtn) {
        restoreBtn.addEventListener('click', async () => {
          if (window.gitlabbar && window.gitlabbar.gitlab) {
            await window.gitlabbar.gitlab.restoreReleases();
            dismissedReleaseIds = [];
            renderReleases();
          }
        });
      }
    }

    // ===== View Mode switching =====
    function applyViewMode() {
      // Hide profile nav when no account is configured
      profileNav.style.display = hasAccounts ? 'flex' : 'none';

      if (viewMode === 'productOwner') {
        // Hide tabs and developer tab contents, show PO content
        tabsBar.style.display = 'none';
        document.getElementById('mrs-content').classList.remove('active');
        document.getElementById('pipelines-content').classList.remove('active');
        document.getElementById('releases-content').classList.remove('active');
        poContent.classList.add('active');
        renderPOView();
      } else {
        // Show tabs and restore developer view
        tabsBar.style.display = hasAccounts ? 'flex' : 'none';
        poContent.classList.remove('active');
        // Restore the current tab
        tabContents.forEach(c => c.classList.remove('active'));
        document.getElementById(`${currentTab}-content`).classList.add('active');
      }
    }

    // ===== Product Owner View =====
    function renderPOView() {
      const list = document.getElementById('po-list');
      const empty = document.getElementById('po-empty');
      const loading = document.getElementById('po-loading');
      const filterContainer = document.getElementById('po-filter');
      const filterSelect = document.getElementById('po-project-filter');

      if (isLoading) {
        loading.style.display = 'flex';
        empty.style.display = 'none';
        filterContainer.style.display = 'none';
        list.innerHTML = '';
        return;
      }

      loading.style.display = 'none';

      if (releases.length === 0) {
        empty.style.display = 'flex';
        filterContainer.style.display = 'none';
        list.innerHTML = '';
        const emptyTitle = document.getElementById('po-empty-title');
        const emptyDesc = document.getElementById('po-empty-desc');
        const configBtn = document.getElementById('configPOBtn');
        if (hasWatchedProjects) {
          emptyTitle.textContent = 'No releases yet';
          emptyDesc.textContent = 'Your followed projects don\'t have any releases yet, or none have been fetched.';
          configBtn.textContent = 'Manage projects';
        } else {
          emptyTitle.textContent = 'No projects configured';
          emptyDesc.textContent = 'Add projects in Preferences → Projects to see their releases here.';
          configBtn.textContent = 'Configure projects';
        }
        return;
      }

      empty.style.display = 'none';

      // Group releases by project
      const releasesByProject = {};
      const projectIdByPath = {};
      releases.forEach(release => {
        const key = release.projectPath || release.projectName || 'Unknown';
        if (!releasesByProject[key]) {
          releasesByProject[key] = [];
        }
        releasesByProject[key].push(release);
        if (release.projectId) {
          projectIdByPath[key] = release.projectId;
        }
      });

      // Build project filter
      const projectPaths = Object.keys(releasesByProject).sort();
      filterContainer.style.display = 'block';
      const currentFilter = poFilterProject;
      filterSelect.innerHTML = '<option value="all">All projects</option>' +
        projectPaths.map(p => `<option value="${escapeHtml(p)}" ${p === currentFilter ? 'selected' : ''}>${escapeHtml(p)}</option>`).join('');

      filterSelect.onchange = function() {
        poFilterProject = filterSelect.value;
        renderPOView();
      };

      // Filter projects if needed
      const filteredProjects = poFilterProject === 'all'
        ? projectPaths
        : projectPaths.filter(p => p === poFilterProject);

      const deploymentStatusTexts = {
        success: 'Deployed',
        running: 'Deploying...',
        failed: 'Failed',
        created: 'Pending',
        canceled: 'Canceled',
      };
      const deploymentIcons = {
        success: '<svg viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 1 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0z"/></svg>',
        running: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="20" stroke-dashoffset="10"/></svg>',
        failed: '<svg viewBox="0 0 16 16"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/></svg>',
        created: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="3"/></svg>',
        canceled: '<svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM5.5 5.5h5v5h-5v-5z"/></svg>',
      };

      let html = '';

      filteredProjects.forEach(projectPath => {
        const projectReleases = releasesByProject[projectPath];
        const projectId = projectIdByPath[projectPath];

        html += `
          <div class="section" data-project-id="${projectId}" data-project-path="${escapeHtml(projectPath)}">
            <div class="po-project-header">
              <div class="po-project-icon">
                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
              </div>
              <span class="po-project-name">${escapeHtml(projectPath)}</span>
              <span class="po-project-count">${projectReleases.length} release${projectReleases.length > 1 ? 's' : ''}</span>
            </div>
            <div class="po-releases-container" data-project-id="${projectId}">
              ${projectReleases.map(release => renderPORelease(release, deploymentStatusTexts, deploymentIcons)).join('')}
            </div>
            ${projectId ? `<button class="po-load-more" data-project-id="${projectId}">Load more releases</button>` : ''}
          </div>
        `;
      });

      list.innerHTML = html;

      // Initialize page tracking
      Object.values(projectIdByPath).forEach(pid => {
        if (!poReleasesPages[pid]) {
          poReleasesPages[pid] = 1;
        }
      });

      // Bind click handlers for release items
      list.querySelectorAll('.po-release-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.po-toggle-desc')) return;
          const url = item.dataset.url;
          if (url && window.gitlabbar && window.gitlabbar.app) {
            window.gitlabbar.app.openExternal(url);
          }
        });
      });

      // Bind expand/collapse description
      list.querySelectorAll('.po-toggle-desc').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const descEl = btn.previousElementSibling;
          if (descEl && descEl.classList.contains('po-release-description')) {
            const isExpanded = descEl.classList.toggle('expanded');
            btn.textContent = isExpanded ? 'Show less' : 'Show more';
          }
        });
      });

      // Bind load more buttons
      list.querySelectorAll('.po-load-more').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const projectId = parseInt(btn.dataset.projectId);
          if (!projectId) return;

          btn.disabled = true;
          btn.textContent = 'Loading...';

          const nextPage = (poReleasesPages[projectId] || 1) + 1;
          try {
            const newReleases = await window.gitlabbar.gitlab.getPOReleases(projectId, nextPage, 5);
            poReleasesPages[projectId] = nextPage;

            if (newReleases.length > 0) {
              const container = list.querySelector(`.po-releases-container[data-project-id="${projectId}"]`);
              if (container) {
                const fragment = document.createElement('div');
                fragment.innerHTML = newReleases.map(release => renderPORelease(release, deploymentStatusTexts, deploymentIcons)).join('');

                // Bind click handlers on new items
                fragment.querySelectorAll('.po-release-item').forEach(item => {
                  item.addEventListener('click', (ev) => {
                    if (ev.target.closest('.po-toggle-desc')) return;
                    const url = item.dataset.url;
                    if (url && window.gitlabbar && window.gitlabbar.app) {
                      window.gitlabbar.app.openExternal(url);
                    }
                  });
                });
                fragment.querySelectorAll('.po-toggle-desc').forEach(tb => {
                  tb.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const descEl = tb.previousElementSibling;
                    if (descEl && descEl.classList.contains('po-release-description')) {
                      const isExpanded = descEl.classList.toggle('expanded');
                      tb.textContent = isExpanded ? 'Show less' : 'Show more';
                    }
                  });
                });

                while (fragment.firstChild) {
                  container.appendChild(fragment.firstChild);
                }

                // Update count
                const section = btn.closest('.section');
                const countEl = section.querySelector('.po-project-count');
                if (countEl) {
                  const total = container.querySelectorAll('.po-release-item').length;
                  countEl.textContent = `${total} release${total > 1 ? 's' : ''}`;
                }
              }
            }

            if (newReleases.length < 5) {
              btn.style.display = 'none';
            } else {
              btn.disabled = false;
              btn.textContent = 'Load more releases';
            }
          } catch (err) {
            console.error('Error loading more releases:', err);
            btn.disabled = false;
            btn.textContent = 'Load more releases';
          }
        });
      });
    }

    function renderPORelease(release, deploymentStatusTexts, deploymentIcons) {
      const deployments = release.deployments || [];

      let envHtml = '';
      if (deployments.length === 0) {
        envHtml = '<span class="deployment-badge none"><svg viewBox="0 0 16 16"><path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/></svg> Not deployed</span>';
      } else {
        envHtml = deployments.map(dep => {
          const depTime = dep.deployedAt ? `<span class="deployment-time">${formatDateTime(dep.deployedAt)}</span>` : '';
          return `<span class="deployment-badge ${dep.status}" title="${dep.deployedAt ? formatDateTime(dep.deployedAt) : ''}">
            ${deploymentIcons[dep.status] || ''}
            ${escapeHtml(dep.environment)}
            ${depTime}
          </span>`;
        }).join('');
      }

      const hasDescription = release.description && release.description.trim().length > 0;
      const descriptionHtml = hasDescription
        ? `<div class="po-release-description">${simpleMarkdown(release.description)}</div>
           <span class="po-toggle-desc">Show more</span>`
        : '';

      const releaseDate = formatDateTime(release.releasedAt || release.createdAt);

      return `
        <div class="po-release-item" data-url="${release.webUrl}">
          <div class="po-release-header">
            <span class="release-tag">${escapeHtml(release.tagName)}</span>
            <span class="po-release-title">${escapeHtml(release.name || release.tagName)}</span>
            <span class="po-release-time">${releaseDate}</span>
          </div>
          <div class="po-env-grid">
            ${envHtml}
          </div>
          ${descriptionHtml}
        </div>
      `;
    }

    // Utilities
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function simpleMarkdown(text) {
      if (!text) return '';
      let html = escapeHtml(text);
      // Headers: ### h3, ## h2, # h1
      html = html.replace(/^### (.+)$/gm, '<strong style="font-size:12px;">$1</strong>');
      html = html.replace(/^## (.+)$/gm, '<strong style="font-size:13px;">$1</strong>');
      html = html.replace(/^# (.+)$/gm, '<strong style="font-size:14px;">$1</strong>');
      // Bold: **text**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic: *text*
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Inline code: `code`
      html = html.replace(/`([^`]+)`/g, '<code style="font-family:\'SF Mono\',Monaco,monospace;font-size:11px;background:var(--bg-base);padding:1px 4px;border-radius:3px;">$1</code>');
      // Links: [text](url)
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color:var(--accent-purple);text-decoration:none;" onclick="event.stopPropagation();window.gitlabbar.app.openExternal(\'$2\');return false;">$1</a>');
      // List items: - item
      html = html.replace(/^[-*] (.+)$/gm, '&bull; $1');
      // Line breaks
      html = html.replace(/\n/g, '<br>');
      return html;
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })
        + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function formatTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'now';
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      return `${days}d`;
    }

    function getAgeInfo(createdAt) {
      if (!createdAt) return { itemClass: '', badgeClass: '' };
      const now = new Date();
      const created = new Date(createdAt);
      const diffMs = now - created;
      const hours = diffMs / 3600000;
      const days = hours / 24;

      if (hours < 24) {
        return { itemClass: 'mr-age-fresh', badgeClass: 'fresh' };
      } else if (hours < 48) {
        return { itemClass: 'mr-age-warning', badgeClass: 'warning' };
      } else if (days < 7) {
        return { itemClass: 'mr-age-alert', badgeClass: 'alert' };
      } else if (days < 30) {
        return { itemClass: 'mr-age-danger', badgeClass: 'danger' };
      } else {
        return { itemClass: 'mr-age-critical', badgeClass: 'critical' };
      }
    }

    function updateStatus(status) {
      statusDot.className = 'status-dot ' + status;
      if (lastUpdated) {
        const time = new Date(lastUpdated).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        lastUpdate.textContent = `Updated at ${time}`;
      }
    }

    // API calls
    async function refresh() {
      try {
        if (window.gitlabbar && window.gitlabbar.gitlab) {
          await window.gitlabbar.gitlab.refresh();
        }
      } catch (err) {
        console.error('Refresh error:', err);
      }
    }

    async function loadData() {
      try {
        if (window.gitlabbar && window.gitlabbar.gitlab) {
          const mrs = await window.gitlabbar.gitlab.getMRs();
          const pipes = await window.gitlabbar.gitlab.getPipelines();
          const rels = await window.gitlabbar.gitlab.getReleases();
          mergeRequests = mrs || [];
          pipelines = pipes || [];
          releases = rels || [];
          lastUpdated = new Date();
          isLoading = false;
          updateStatus('connected');
          renderMRs();
          renderPipelines();
          renderReleases();
        }
      } catch (err) {
        console.error('Load error:', err);
        isLoading = false;
        updateStatus('error');
        renderMRs();
        renderPipelines();
        renderReleases();
      }
    }

    // Listen for data updates from main process
    if (window.gitlabbar && window.gitlabbar.on) {
      window.gitlabbar.on.dataUpdated(async (data) => {
        mergeRequests = data.mergeRequests || [];
        pipelines = data.pipelines || [];
        releases = data.releases || [];
        lastUpdated = new Date(data.lastUpdated);
        isLoading = false;
        // Check accounts in case they were added/removed
        await checkAccounts();
        // Reload viewMode and watched projects in case they changed from preferences
        await loadViewMode();
        await loadWatchedProjects();
        updateStatus(data.error ? 'error' : 'connected');
        renderMRs();
        renderPipelines();
        renderReleases();
        applyViewMode();
      });
    }

    // Check if accounts are configured
    async function checkAccounts() {
      try {
        if (window.gitlabbar && window.gitlabbar.accounts) {
          const accounts = await window.gitlabbar.accounts.getAll();
          hasAccounts = accounts && accounts.length > 0;
        }
      } catch (err) {
        console.error('Error checking accounts:', err);
        hasAccounts = false;
      }
    }

    // Load viewMode from config
    async function loadViewMode() {
      try {
        if (window.gitlabbar && window.gitlabbar.config) {
          const vm = await window.gitlabbar.config.get('viewMode');
          viewMode = vm || 'developer';
        }
      } catch (err) {
        console.error('Error loading viewMode:', err);
      }
      updateProfileNavUI();
    }

    // Load whether user has configured watched projects (for PO empty state message)
    async function loadWatchedProjects() {
      try {
        if (window.gitlabbar && window.gitlabbar.config) {
          const ids = await window.gitlabbar.config.get('watchedProjectIds');
          hasWatchedProjects = Array.isArray(ids) && ids.length > 0;
        }
      } catch (err) {
        console.error('Error loading watched projects:', err);
        hasWatchedProjects = false;
      }
    }

    // Initial render (shows loading state)
    renderMRs();
    renderPipelines();
    renderReleases();

    // Load data on start
    async function init() {
      await checkAccounts();
      await Promise.all([
        loadDismissedPipelines(),
        loadDismissedMRs(),
        loadDismissedReleases(),
        loadViewMode(),
        loadWatchedProjects()
      ]);
      await loadData();
      applyViewMode();
    }
    setTimeout(init, 100);
  </script>
</body>
</html>
